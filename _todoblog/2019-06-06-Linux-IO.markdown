---
layout: post
title: Linux IO概述
date: 2019-06-06 15:52
header-img: "img/head.jpg"
categories: jekyll update
tags:
  - Linux
typora-root-url: ../../yummyliu.github.io
---

* TOC
{:toc}
## 概述

```c++
#include <fstream>
#include <cstring>
#include <iostream>
using namespace std;

struct Person
{
	char name[50];
	int age;
	char phone[24];
	double high;
};

int main () {
	Person mem;
	ifstream infile;
	infile.open("log.dat", ios::binary|ios::in);
	infile.read((char*)&mem, sizeof(Person));
	infile.close();
  
  mem.age++;
	std::cout << mem.age  << ' ';
	std::cout << mem.name << ' ';
	std::cout << mem.phone<< ' ';
	std::cout << mem.high<< std::endl;

	ofstream outfile;
	outfile.open("log.dat", ios::binary|ios::out);
	outfile.write((char*)&mem, sizeof(mem));
	outfile.close();


	return 0;
}
```



![img](/image/linuxio.png)

## Linux AIO 与 directio

> [http://nginx.org/en/docs/http/ngx_http_core_module.html#aio](http://nginx.org/en/docs/http/ngx_http_core_module.html#aio)
>
> When both AIO and [sendfile](http://nginx.org/en/docs/http/ngx_http_core_module.html#sendfile) are enabled on Linux, AIO is used for files that are larger than or equal to the size specified in the [directio](http://nginx.org/en/docs/http/ngx_http_core_module.html#directio) directive, while [sendfile](http://nginx.org/en/docs/http/ngx_http_core_module.html#sendfile) is used for files of smaller sizes or when [directio](http://nginx.org/en/docs/http/ngx_http_core_module.html#directio) is disabled.

## zero-copy

### sendfile()

（Java NIO的transferTo）：不需要内核态和用户态之间的数据拷贝，但是DMA需要在内核中需要维护一个连续的buffer用来传输数据。

![img](/image/sendfile.png)

如果硬件上支持*scatter-n-gather*，那么可以省去这个buffer。

![img](/image/scater.png)

## memory-map

### mmap()/munmap()

![img](/image/mmap.png)

（Java NIO的MappedByteBuffer）上面的zero-copy中，用户态进程只能等待IO完成。如果期间希望操作数据，可以使用mmap。mmap将外存的文件块映射到内存中，虽然又带来了4次上下文切换，但是可以利用OS的页面管理（虚拟空间映射，页面缓存与自动刷出，页面对齐等）。同样会带来占用进程页表和TLB缓存的代价。