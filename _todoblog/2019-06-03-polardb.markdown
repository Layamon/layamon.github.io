---
layout: post
title: PolarFS与NVM
date: 2019-06-03 16:17
header-img: "img/head.jpg"
categories: jekyll update
tags:
  - Paper
typora-root-url: ../../yummyliu.github.io
---

* TOC
{:toc}
# 研究背景

## 新硬件

### RDMA

SPDK

### Non-Volatile Memory

新型非易失存储器在持久化、随机读写能力、存储密度、扩展能力、漏电功耗等多个方面与传统的存储介质相比具有明显优势。主要考虑是的两个方面：

+ 持久化：融入 NVM 的新型存储环境有望跨越 CPU 与外存之间的性能鸿沟,消除计算机系统中制约上层软件设计的 I/O 瓶颈。

+ 直接寻址：基于一个事实：超大容量的便宜外存一直会存在于系统中；那么PMMU(page memory manager unit)就会一直存在，复制page in/out；因此，page永远是一个读写的最小单位。因此，直接寻址可预见的未来中，还是对于virtual memory的直接寻址。

### 可持久化存储器

+ HDD：机械硬盘

+ NAND介质：常说的闪存记忆卡，USB，NAND SSD
+ 3DX Point介质：Intel出的基于3DX的一系列新的存储器，可称为Optane SSD，性能好，价格贵；可以作为内存的扩展或者外存的cache来用，但是要求上层软件基于其有优化。3D Xpoint较之DRAM，虽然性能稍差，但3D Xpoint不易失，也就是不像DRAM受断电问题的困扰；与NAND相比，3D Xpoint强在性能上。因此，NVM-oriented database的架构开始讨论了，比如N-store。
  + Optane SSD: 常见的3DX技术的载体，通常用在个人电脑中，比NAND-based SSD快。
  + Optane Memory：传统的磁盘的缓冲区。
  + Optane DC Persistent Memory：用在Data Center中的服务器技术。
  + Optane Memory SSD：将Optane和普通SSD混合的产物。

#### NVMe

NVMe和NVM不是一个东西；NVMe是和AHCI是同一类同，其是一个存储接口协议，AHCI是早期将HDD接到PCIe上的存储接口协议；NVMe是适配SSD接到PCIe上的存储接口协议。

## 共享分布式文件系统的数据库

将传统的本地文件系统抽象为一个分布式文件系统；提供类似的文件api；db基于日志即数据的概念，将redo日志放在分布式文件系统中冗余存储；这样读写节点共享同一份数据。

+ 日志的存储：主节点将redo日志，调用api写入分布式文件系统中。

+ 数据的构建：ro节点从分布式文件系统中，读取相应的数据；如果

+ 从库如何回放：

+ 主从内存状态如何保持一致：

- 内存中的索引管理：
- 元数据如何同步：



# PolarFS结构概述

![image-20190604181103288](/image/image-20190604181103288.png)



## PolarFS的写流程

1. PolarDB基于libpfs，通过ringbuffer向PolarSwitch发送IO请求
2. PolarSwitch根据本地的metadata cache，将IO请求通过RDMA转发到Chunkserver Leader
3. RDMS NIC模块将请求放到本地的buffer中，由chunkserver不断的拉取处理
4. 写请求通过SPDK，写入到log块中，然后通过RDMA传播到其他follower中(这里都是异步操作，并且数据传输可以并行)
5. follower接收到IO数据，将其写入到本地的buffer中
6. follower利用SPDK将buffer中的数据异步写入到磁盘中
7. leader从**大部分**的follower都收到成功的ack后，然后通过SPDK，将数据写入到data块中。
8. leader通过RDMA，向PolarSwitch返回success
9. PolarSwitch标记该请求done，向client返回成功。

## PolarFS的关键点

+ bypass Net/IO stack

  避免陷入内核态的代价

+ ParallelRaft

  高fs的吞吐

+ POSIX-like的文件系统API

  向上兼容

+ 避免锁和上下文切换

# NVM存储探索

SSD本来具有可随机访问，持久存储的特性；但是读写性能上和内存还是有差距；在Intel提出了基于3DX Point介质的新SSD之后，针对非易失性存储器的数据库架构的研究有很多。

## NVM-only 存储架构

+ 不考虑

## NVM+DRAM 混合存储架构

+ NVM 的组提交(NVRAM group commit)恢复机制.该机制消除了传统管理日志所需要的缓存区,利用批量事务
  处理模式减少了确保正确次序所需的写障栅次数
+ 

- 