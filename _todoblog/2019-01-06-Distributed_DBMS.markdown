---

layout: post
title: 
date: 2019-01-06 11:25
header-img: "img/head.jpg"
categories: jekyll update
tags:
typora-root-url: ../../yummyliu.github.io
---
> 一开始写这个博客的初衷是在校期间的学习笔记，可以看到每篇博客都特别凌乱且没有章法；不过这一年来好多了，但是每次翻看之前的blog，我自己都不想看下去；主要的原因是觉得也没人看，不过最近发现还是有读者的，决定之后认真对待每一个blog。2019年开年第一篇blog，这里要立一个flag——以后的每一篇blog要有明确的主题并且阐述到位，确保搜索到这篇文章的人能够在页面上停留大于5分钟，不能仅仅当做一个凌乱的笔记。
>
> ![image-20190106114108370](/image/dau.png)



近些年随着大数据的火热发展，作为互联网数据的载体，数据库的的概念层出不穷，不管是NoSQL还是NewSQL，或者面向OLAP还是OLTP的。本文主要阐述分布式数据库的若干概念，希望看到这篇文章的你，如果希望了解这个方向，能够在读完有所收获（本文仅代表个人观点，要带着批判的眼光来看待）。

本文分为以下几个内容：

* TOC
{:toc}
# Why Distributed

| 考虑因素 | 单机                             | 分布式                                       |
| -------- | -------------------------------- | -------------------------------------------- |
| 性能瓶颈 | 单机的资源上限：CPU核数/磁盘带宽 | 通信代价                                     |
| 可用性   | 单点问题                         | 多活副本                                     |
| 伸缩性   | 受限于单个机器                   | 集群理论上没有伸缩上限                       |
| 数据热点 |                                  | 公司的不同地方的不同部门，将数据放在自己这里 |

# Distributed Problems

分布式数据库有好处，同样也会存在问题；比如系统设计就会更加复杂，并且需要处理多节点之间通信的额外开销；很难保障多节点的数据完整性，以及多节点的数据分布方式会影响分布式查询的性能。

## CAP理论

> 老生常谈的CAP理论，是分布式系统基石。

对于无状态的分布式系统，系统间的协调几乎就没有必要了；但是对于像数据库这种有状态的，就需要在C/A/P之间权衡了（Principles of Distributed Computing ——Eric Brewer）。

+ (强)Consistency：确保client链接上的每个node，都是看到相同的，最新的数据；并且能够成功的写入。这种一致性是一种强的序列化的一致性。

+ Availability：**每个**有效节点都能在**合理的时间**内响应读写请求；

+ Partition Tolerant：由于网络隔离或机器故障，将系统分割后，系统能够继续保持服务并且保持一致性；当分割恢复后，能够优雅的恢复回来。

> 这里的**CA**和ACID中的**CA**是两码事

由于CAP三者不能同时满足，从而有状态的分布式系统就分为了三种类型：

+ CP：当系统出现网络分区时，这时牺牲了可用性，保障分区容忍性。
+ CA：如果单机的DB算一个分布式系统，那么就算一个CA的系统，可是不是。
+ AP：并不保证多节点数据的一致性，但是保证可用性和分区容忍性。

但是，网络分布式系统中，由于node之间是通过网络进行通信的，网络分割是常有的事。

因此，分布式系统一般就是在考虑在产生网络分区时，我们应该优先保证**强一致性**还是**完美的可用性**。但是一般我们是尽量两方面都做到尽量好。

























## 分布式事务

### 2PL

### 无锁的2PL

#### Raft协议

### 分布式事务的（死）锁

#### 分布式死锁避免

#### 分布式死锁检测

## 数据分布

对于数据库中的表数据有不同的分布方式：

- 无副本，无分段
- 副本
  - Snapshot replica
  - Near-real-time replica
  - Pull replica
- 分段
  - 水平分段
  - 垂直分段
  - 混合分段
- 混合：分段且冗余

## 用户透明

+ 位置透明：用户对待远程的分布式数据库，和对待本地数据库相同。

+ 分段透明：用户不知道数据被分割存储。

+ 副本透明：用户不知道数据有多个副本。

## 查询计划优化

![Distributed Query Processing Architecture](/image/distributed_query_architecture.png)

+ 查询算子： Projection/Selection/Union/Intersection/Minus/Join

单机查询计划，基于统计信息进行启发式搜索。

分布式查询计划

+ 最大化集群资源利用率

![Optimal Utilization Distributed System](/image/optimal_utilization_distributed_system.png)

对于第三种，左侧收到操作符，但是将数据传递给计算性能更好（ie. 多核）的右侧机器

计算，然后返回结果。

+ 减少整个的返回结果集，进而减少网络代价。







# Distributed DBMS

分布式数据库可以分为同构和异构两种.同构的分布式数据库又分为自治的（**Autonomous**）和非自治的。异构数据数据库有分为联合的（**Federated**）和非联合的；



分布式





